## Как написать tg-bot, выдающий оценки из ведомости ##

#### Давайте опишем простым языком идею, которую мы хотим реализовать: #
- Есть **ведомость с оценками** за курс по Питону. На двух листах содержатся оценки, как за отдельные элементы контроля, так и посчитанные по формулам.<br>

- Есть **две группы студентов**, которым бы хотелось быстро и просто узнавать свои баллы (не все, а ключевые - средняя, за Кр, итоговая), не заходя в ведомость.<br>

- Мы **хотим сделать Бота**, который по введенным "Фамилии и имени" выдавал бы оценки.<br>

Чтобы это реализовать, мы будем использовать библиотеку ```pandas``` для работы с данными из Excel и библиотеку ```telebot``` для взаимодействия с Telegram API.<br>

#### Начнем разбираться по пунктам и увидим, что главное в создании бота понять две вещи:

1. Что мы хотим получить.
2. Как это реализовать.

### Пункт 1. Импортируем библиотеки

```python
import telebot
import pandas as pd
```

```telebot```: это библиотека для работы с Telegram Bot API, которая позволяет создавать ботов для Telegram.<br>
```pandas```: это библиотека для работы с данными, которая предоставляет структуры данных и функции для анализа данных. В данном случае мы используем ее для работы с Excel-файлом.
<br>

### Пункт 2. Создаем бота.

#### Сразу важное отступление! #
#### Чтобы создать собственного бота нам нужен бот. #
[@BotFather](https://t.me/BotFather) отлично в этом поможет. Парой команд мы получаем наш **Bot API**, называем его, выбираем картиночку, добавляем описание и прочее. И вот потом имеем строчку, свяживающую наш последующий код с тем ботом, который оживет и реально начнет работать.<br>
**Прописываем нашего бота,** где много букв и цифр - этот токен используется для доступа к HTTP API и взаимодействия с телеграмом.
```python
bot = telebot.TeleBot('4834753573-sbjgbygbajgevaarv - и что-то подобное -сюда вы пишете свой токен')
```

### Пункт 3. Про данные.<br>

Создаем словарь для хранения данных пользователей.

```python
user_data = {}
```
Поскольку у нас есть таблица в Excel, в которой указаны данные по двум группам, имеются **два листа с названиями "Чистмат" и "Совбак"**.<br>
Мы хотим создать функцию, которая загружает данные из Excel-файла в зависимости от выбранного направления (Чистмат или Совбак). Она использует ```pandas.read_excel``` для чтения данных из указанного листа.<br>
```python
def load_data(department):
    sheet_name = 'Чистмат' if department == 'Чистмат' else 'Совбак'
    return pd.read_excel('Ведомость (Python, матфак).xlsx',
                         sheet_name=sheet_name)
```

### Пункт 4. Начинаем.<br>

**Пропишем обработчик**, который сработает, когда пользователь отправит команду /start. Он отправляет приветственное сообщение и инициализирует словарь для хранения данных пользователя.<br>
```python
@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message,
                 "Привет! Если хочешь узнать оценки по Питону, "
                 "напиши пожалуйста, ты Чистмат или Совбак?")
    user_data[message.chat.id] = {}
```

### Пункт 5. Выбираем группу - Чистмат или Совбак.<br>

Наш бот узнает, к какой группе относится студент, сохраняет это значение и загружает соответствующие данные, используя функцию ```load_data```. После этого бот просит пользователя ввести фамилию и имя.<br>
```python
@bot.message_handler(func=lambda message: message.text.lower() in ['чистмат', 'совбак'])

def get_department(message):
    if message.chat.id not in user_data:
        user_data[message.chat.id] = {}

    department = message.text.lower().capitalize()
    user_data[message.chat.id]['department'] = department
    # Это так мы листочек нужный выбираем
    user_data[message.chat.id]['data'] = load_data(department)
    bot.reply_to(message, "Отлично, напиши пожалуйста фамилию и имя.")
```

### Пункт 6. Получаем данные из таблицы.<br>

После ввода Фамилии и имени в загруженной таблице ищем данные студента с помощью метода ```str.contains```, который проверяет, содержится ли введенная строка в столбце 'ФИО'.<br>
**Еще пропишем такое:** в случае ошибки (например, если данные не загружены) бот отправляет сообщение об ошибке.<br>
```python
@bot.message_handler(func=lambda message:
                     message.chat.id in user_data and 'data'
                     in user_data[message.chat.id])
def get_grades(message):
    fio = message.text.strip()
    data = user_data[message.chat.id]['data']
    
    try:
        student_data = data[data['ФИО'].str.contains(fio,
                                                     case=False, na=False)]
    except Exception as e:
        bot.reply_to(message, f"Произошла ошибка: {e}")
        return
```

### Пункт 7. Ответ от бота, делаем его красивым.<br>

Если данные студента найдены, бот формирует ответ, используя цикл ```for``` для перебора строк с данными студента. Он проверяет, есть ли оценки, и округляет их до двух знаков после запятой.<br><br>
**Добавим такое условие для автоматов:** Если итоговая оценка равна 8.0, добавляется сообщение о перезачете.<br>
**И соответственно условие:** если данные не найдены, бот отправляет сообщение о том, что студент не найден.<br>
```python
    if not student_data.empty:
        response = ""
        for index, row in student_data.iterrows():
            response += (
                f"ФИО: {row['ФИО']}\n"
                f"""Средняя за ДЗ: {round(row['Средняя ДЗ'], 2)
            if not pd.isna(row['Средняя ДЗ'])
            else 'балл пока не стоит'}\n"""
                f"""Средняя за СР: {round(row['Средняя СР'], 2)
            if not pd.isna(row['Средняя СР'])
            else 'балл пока не стоит'}\n"""
                f"""Контрольная: {round(row['КР'], 2)
            if not pd.isna(row['КР'])
            else 'балл пока не стоит'}\n"""
                f"""Проект: {round(row['Проект'], 2)
            if not pd.isna(row['Проект'])
            else 'балл пока не стоит'}\n"""
                f"""Экзамен: {round(row['Экзамен'], 2)
            if not pd.isna(row['Экзамен'])
            else 'балл пока не стоит'}\n"""
                f"""Итоговая: {round(row['Итоговая'], 2)
            if not pd.isna(row['Итоговая'])
            else 'балл пока не стоит'}\n\n"""
            )
            if not pd.isna(row['Итоговая']) and row['Итоговая'] == 8.0:
                response += "Курс был перезачтён\n\n"
        bot.reply_to(message, response.strip())
```

### Пункт*<br>

#### Мне хотелось, чтобы бот был добрее и дружелюбнее. Кроме данных из таблицы он мог бы выдать что-то хорошее, поэтому я прописала следующие строки. <br>
```python
        bot.reply_to(message,
                     "Желаю тебе отлично сдать проект, "
                     "экзамен и просто выучить Питон!")
        bot.reply_to(message,
                     "Если узнать еще чьи-то оценки, то напиши, "
                     "этот человек Чистмат или Совбак?")
    else:
        bot.reply_to(message, "Студент с такой фамилией не найден.")
```
Они отправляются в отдельных сообщениях сразу после сообщения с результатами.<br>

### Пункт 8. Для всяких неожиданностей.<br>

Чтобы сработать относительно правильно при не совсем ясном ответе, мы пропишем условие, которое позволит задать первоначальный вопрос в случае путаницы.<br>
```python
@bot.message_handler(func=lambda message: True)
def handle_unexpected_message(message):
    if message.chat.id not in user_data:
        bot.reply_to(message, "Привет! Если хочешь узнать оценки по Питону, "
                     "напиши пожалуйста, ты Чистмат или Совбак?")
    else:
        bot.reply_to(message, "Пожалуйста, напиши фамилию и имя.")

```

### Пункт 9. Две строки или как заставить всё работать.<br>

Эта конструкция запускает бота и позволяет ему обрабатывать входящие сообщения в режиме реального времени, а метод polling постоянно проверяет наличие новых сообщений.
```python
if __name__ == '__main__':
    bot.polling()
```
Вот так, за 9 шагов мы создали телеграм бота, который из большой общей таблицы находит нужные данные и отправляет пользователю.
<br>

### Пример диалога с ботом:

**MathFacPython_marks:** Привет! Если хочешь узнать оценки по Питону, напиши пожалуйста, ты Чистмат или Совбак?
<br>
**Софья:** Совбак
<br>
**MathFacPython_mark:** Отлично, напиши пожалуйста фамилию и имя.
<br>
**Софья:** Никитина Софья
<br>
**MathFacPython_marks:** <br>
ФИО: Никитина Софья Витальевна<br>
Средняя за ДЗ: 9.0<br>
Средняя за СР: 6.06<br>
Контрольная: 3.0<br>
Проект: балл пока не стоит<br>
Экзамен: балл пока не стоит<br>
Итоговая: 2.71<br>
**MathFacPython_marks:** Желаю тебе отлично сдать проект, экзамен и просто выучить Питон!
<br>
**MathFacPython_marks:** Если узнать еще чьи-то оценки, то напиши, этот человек Чистмат или Совбак?

### Итог. Созданный бот.<br>
У нас была идея - **с помощью бота сделать получение данных удобным.** Наш код создает **Telegram-бота**, который позволяет пользователям запрашивать оценки студентов по двум направлениям (Чистмат и Совбак). Он использует библиотеку ```pandas``` для работы с данными из Excel и библиотеку ```telebot``` для взаимодействия с Telegram API.<br>
**За 9 шагов мы реализовали нашу идею на Питоне, опробовали, учли возможные неожиданные сообщения со стороны пользователя, всё прописали и отпустили в жизнь.**
